{% extends "base.html" %}

{% block title %}Manage Athletes{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h2>Manage Athletes</h2>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
</div>

<div class="card">
    <h3>Add New Athlete</h3>
    <form method="POST" action="{{ url_for('create_athlete') }}">
        <div class="form-group">
            <label for="club_id">Club</label>
            <select id="club_id" name="club_id">
                <option value="">Unassigned</option>
                {% for club in clubs %}
                <option value="{{ club.id }}">{{ club.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="division_id">Division</label>
            <select id="division_id" name="division_id">
                <option value="">Unassigned</option>
                {% for division in divisions %}
                <option value="{{ division.id }}">{{ division.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required>
        </div>
        <div class="form-group">
            <label for="full_name">Full Name</label>
            <input type="text" id="full_name" name="full_name" required>
        </div>
        <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" required>
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required>
        </div>
        <div class="form-group">
            <label for="program_id">Program <span style="color: var(--error-color);">*</span></label>
            <select id="program_id" name="program_id" required onchange="updateTeamsForProgram()">
                <option value="">Select Program</option>
                {% for program in programs %}
                <option value="{{ program.id }}">{{ program.name }}</option>
                {% endfor %}
            </select>
            <small style="color: var(--text-secondary);">Select the athlete's program (U12, U14, U16, or U18/U21)</small>
        </div>
        <div class="form-group">
            <label for="team_id">Assign to Team (Optional)</label>
            <select id="team_id" name="team_id" onchange="updateCoachFromTeam()">
                <option value="">Select Team</option>
                {% for team in teams %}
                <option value="{{ team.id }}" data-coach="{{ team.coach_id }}" data-program="{{ team.program_id }}">
                    {{ team.name }} ({{ team.program.name }}) - {{ team.coach.full_name }}
                </option>
                {% endfor %}
            </select>
            <small style="color: var(--text-secondary);">Optionally assign the athlete to a team</small>
        </div>
        <div class="form-group">
            <label>Program Participation</label>
            <div>
                <input type="checkbox" id="participates_snow_stars" name="participates_snow_stars" checked>
                <label for="participates_snow_stars" style="display: inline; margin-left: 0.5rem;">Racing - Snow Stars (ACA)</label>
            </div>
            <small style="color: var(--text-secondary);">Enable Snow Stars to evaluate this athlete</small>
        </div>
        <input type="hidden" id="coach_id" name="coach_id" value="">
        <button type="submit" class="btn btn-primary">Create Athlete</button>
    </form>
</div>

<div class="card">
    <h3>All Athletes</h3>
    {% if athletes %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Username</th>
                <th>Email</th>
                <th>Club</th>
                <th>Division</th>
                <th>Team</th>
                <th>Coach</th>
                <th>Program</th>
                <th>Snow Stars</th>
                <th>Current Level</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for athlete in athletes %}
            {% set racing_evals = athlete.evaluations_received|selectattr('sport_type', 'equalto', 'snow_stars')|list %}
            {% set highest_level = racing_evals|map(attribute='level')|list|max if racing_evals else 0 %}
            <tr>
                <td>{{ athlete.full_name }}</td>
                <td>{{ athlete.username }}</td>
                <td>{{ athlete.email }}</td>
                <td>{{ athlete.club.name if athlete.club else '-' }}</td>
                <td>{{ athlete.division.name if athlete.division else '-' }}</td>
                <td>{{ athlete.team.name if athlete.team else 'Not assigned' }}</td>
                <td>{{ athlete.coach.full_name if athlete.coach else '-' }}</td>
                <td>
                    {% if athlete.program %}
                    <strong>{{ athlete.program.name }}</strong>
                    {% else %}
                    <span style="color: var(--error-color);">Not assigned</span>
                    {% endif %}
                </td>
                <td>
                    {% if athlete.participates_snow_stars %}
                    <span class="badge badge-sport" style="background-color: #fef3c7; color: #854d0e;">Enabled</span>
                    {% else %}
                    <span style="color: var(--text-secondary);">Disabled</span>
                    {% endif %}
                </td>
                <td>
                    {% if highest_level > 0 %}
                    Level {{ highest_level }}
                    {% else %}
                    <span style="color: var(--text-secondary);">Not started</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('view_athlete', athlete_id=athlete.id) }}" class="btn btn-sm btn-secondary">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No athletes yet. Create one above.</p>
    {% endif %}
</div>

<script>
function updateCoachFromTeam() {
    const teamSelect = document.getElementById('team_id');
    const coachInput = document.getElementById('coach_id');
    const selectedOption = teamSelect.options[teamSelect.selectedIndex];
    
    if (selectedOption.value) {
        coachInput.value = selectedOption.getAttribute('data-coach');
        // Also update program if team is selected and program is not set
        const programId = selectedOption.getAttribute('data-program');
        const programSelect = document.getElementById('program_id');
        if (programId && !programSelect.value) {
            programSelect.value = programId;
        }
    } else {
        coachInput.value = '';
    }
}

function updateTeamsForProgram() {
    const programSelect = document.getElementById('program_id');
    const teamSelect = document.getElementById('team_id');
    const selectedProgramId = programSelect.value;
    
    // Filter teams to only show those matching the selected program
    for (let i = 0; i < teamSelect.options.length; i++) {
        const option = teamSelect.options[i];
        if (option.value === '') {
            continue; // Keep the "Select Team" option visible
        }
        const teamProgramId = option.getAttribute('data-program');
        if (selectedProgramId && teamProgramId !== selectedProgramId) {
            option.style.display = 'none';
        } else {
            option.style.display = 'block';
        }
    }
    
    // Clear team selection if it doesn't match the program
    const selectedTeam = teamSelect.options[teamSelect.selectedIndex];
    if (selectedTeam.value && selectedProgramId) {
        const teamProgramId = selectedTeam.getAttribute('data-program');
        if (teamProgramId !== selectedProgramId) {
            teamSelect.value = '';
        }
    }
}
</script>
{% endblock %}

